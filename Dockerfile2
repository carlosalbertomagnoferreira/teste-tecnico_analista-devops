FROM composer:2.8.12 AS builder

WORKDIR /app
COPY . .

RUN composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

FROM php:8.3-fpm-alpine3.22

# Update de pacotes, correção de vulnerabilidades
RUN apk update && apk upgrade

# Instalando Nginx, fcgi e copiando arquivo de configuração
RUN apk add --no-cache \
    fcgi \
    nginx && \
    rm -rf /var/cache/apk/*
COPY ./docker/nginx/nginx.conf /etc/nginx/nginx.conf

# Download e instalação do php-fpm health check script
RUN curl -o /usr/local/bin/php-fpm-healthcheck \
https://raw.githubusercontent.com/renatomefi/php-fpm-healthcheck/master/php-fpm-healthcheck \
&& chmod +x /usr/local/bin/php-fpm-healthcheck
RUN set -xe && echo "pm.status_path = /status" >> /usr/local/etc/php-fpm.d/zz-docker.conf

# Definindo diretorio de trabalho para contrução da imagem
WORKDIR /var/www/html

# Copiando arquivos do repositorio para a imagem
COPY --chown=www-data:www-data . .

COPY --chown=www-data --from=builder /app/vendor /var/www/html/vendor

# Transferindo arquivo de inicialização
COPY ./docker/php-fpm/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Porta de acesso ao php-fpm
EXPOSE 80

# healthcheck do php-fpm, verificando o serviço a cada 30 segundos
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD php-fpm-healthcheck || exit 1

# executa o php-fpm na inicialização do container
CMD ["php-fpm"]

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]